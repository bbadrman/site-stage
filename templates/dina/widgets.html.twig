{% extends 'dina_base.html.twig' %}

{% block title %}Widgets{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ asset('css/widgets.css') }}">
{% endblock %}

{% block body %}
<section class="w-page">
  <div class="w-bg">
    <div class="w-orb o1"></div>
    <div class="w-orb o2"></div>
    <div class="w-orb o3"></div>
    <div class="w-grid"></div>
  </div>

  <div class="w-wrap">

    <!-- BIG CARD -->
    <article class="w-card w-card--big">
      <div class="w-top">
        <div>
          <h2>Tech Giants <span class="w-step" id="wStep">(1/7)</span></h2>
          <p class="w-sub">Chart + tabs + ranges</p>
        </div>

        <div class="w-progress" title="Auto progress">
          <span class="w-bar" id="wBar" style="width: 14%"></span>
        </div>
      </div>

      <div class="w-tabs" data-tabs>
        <button class="w-pill active" data-symbol="NVDA">NVDA</button>
        <button class="w-pill" data-symbol="AAPL">AAPL</button>
        <button class="w-pill" data-symbol="MSFT">MSFT</button>
        <button class="w-pill" data-symbol="AMZN">AMZN</button>
        <button class="w-pill" data-symbol="GOOGL">GOOGL</button>
        <button class="w-pill" data-symbol="META">META</button>
        <button class="w-pill" data-symbol="TSLA">TSLA</button>
      </div>

      <div class="w-chart">
        <div class="w-chart-grid"></div>
        <svg class="w-line" viewBox="0 0 900 260" preserveAspectRatio="none" aria-label="chart">
          <path id="wPath" d=""></path>
        </svg>
      </div>

      <div class="w-meta">
        <div class="w-meta-left">
          <span class="w-badge" id="wSym">NVDA</span>
          <strong id="wPrice">—</strong>
          <span class="w-chg up" id="wChg">—</span>
        </div>

        <div class="w-meta-right">
          <span>Day Hi/Lo: <b id="wHL">—</b></span>
          <span>Volume: <b id="wVol">—</b></span>
          <span>At: <b id="wAt">—</b></span>
        </div>
      </div>

      <div class="w-range" data-range>
        <button class="w-range-btn" data-r="1D">1D</button>
        <button class="w-range-btn" data-r="5D">5D</button>
        <button class="w-range-btn active" data-r="1M">1M</button>
        <button class="w-range-btn" data-r="6M">6M</button>
        <button class="w-range-btn" data-r="YTD">YTD</button>
        <button class="w-range-btn" data-r="1Y">1Y</button>
        <button class="w-range-btn" data-r="5Y">5Y</button>
        <button class="w-range-btn" data-r="ALL">ALL</button>
      </div>
    </article>

    <!-- MARKET LIST -->
    <section class="w-market">
      <div class="w-market-head">
        <h3>Today's Market</h3>

        <div class="w-controls">
          <div class="w-toggle" data-toggle>
            <button class="active" data-mode="intraday">Intraday</button>
            <button data-mode="daily">Daily</button>
          </div>
          <button class="w-refresh" id="wRefresh">Refresh</button>
        </div>
      </div>

      <div class="w-list" id="wList"></div>
      <p class="w-madeby">Crafted for AKSAM</p>
    </section>

    <!-- CRYPTO TICKER -->
    <section class="w-ticker" aria-label="crypto ticker">
      <div class="w-ticker-fade left"></div>
      <div class="w-ticker-fade right"></div>

      <div class="w-track">
        <div class="w-run" id="wRun"></div>
      </div>
    </section>

  </div>
</section>
{% endblock %}

{% block javascripts %}
<script>
  // ===== config =====
  const TECH = ["NVDA","AAPL","MSFT","AMZN","GOOGL","META","TSLA"];
  const MARKET = ["AAPL","MSFT","NVDA","AMZN","GOOGL","TSLA","META"];
  const CRYPTO = ["BTC-USD","ETH-USD","SOL-USD","XRP-USD","ADA-USD","DOGE-USD","AVAX-USD","LINK-USD"];

  const RANGE_MAP = { "1D":"1d", "5D":"5d", "1M":"1mo", "6M":"6mo", "YTD":"ytd", "1Y":"1y", "5Y":"5y", "ALL":"max" };

  let activeSymbol = "NVDA";
  let activeRange = "1mo";
  let autoIndex = 0;
  let autoTimer = null;

  // ===== utils =====
  function pointsToPath(values, w=900, h=260, pad=18){
    if(!values || values.length < 2) return "";
    const minY = Math.min(...values);
    const maxY = Math.max(...values);
    const sx = (i)=> pad + (i/(values.length-1))*(w-2*pad);
    const sy = (y)=> (h-pad) - ((y-minY)/(maxY-minY || 1))*(h-2*pad);

    let d = `M ${sx(0)} ${sy(values[0])}`;
    for(let i=1;i<values.length;i++) d += ` L ${sx(i)} ${sy(values[i])}`;
    return d;
  }

  const fmt = (n)=> (n===null||n===undefined) ? "—" : new Intl.NumberFormat("fr-FR",{maximumFractionDigits:2}).format(n);
  const fmtPct = (n)=> (n===null||n===undefined) ? "—" : new Intl.NumberFormat("fr-FR",{maximumFractionDigits:2}).format(n)+"%";
  const fmtVol = (n)=>{
    if(!n) return "—";
    if(n>=1e9) return (n/1e9).toFixed(2)+"B";
    if(n>=1e6) return (n/1e6).toFixed(2)+"M";
    if(n>=1e3) return (n/1e3).toFixed(2)+"K";
    return String(n);
  };

  async function api(url){
    const res = await fetch(url);
    if(!res.ok) throw new Error("API error");
    return res.json();
  }

  // ===== render big widget =====
  async function renderBigCard(){
    const data = await api(`/api/widgets/quote/${activeSymbol}?range=${activeRange}`);

    // step/progress
    const i = TECH.indexOf(activeSymbol);
    document.getElementById("wStep").textContent = `(${(i>=0?i:0)+1}/7)`;
    document.getElementById("wBar").style.width = `${((i>=0?i:0)+1)/7*100}%`;

    document.getElementById("wSym").textContent = data.symbol;
    document.getElementById("wPrice").textContent = fmt(data.last);

    const isUp = (data.change ?? 0) >= 0;
    const chgEl = document.getElementById("wChg");
    chgEl.classList.toggle("up", isUp);
    chgEl.classList.toggle("down", !isUp);
    chgEl.textContent = `${isUp?"+":""}${fmt(data.change)} (${isUp?"+":""}${fmtPct(data.changePct)})`;

    document.getElementById("wHL").textContent = `${fmt(data.dayHigh)} / ${fmt(data.dayLow)}`;
    document.getElementById("wVol").textContent = fmtVol(data.volume);

    document.getElementById("wAt").textContent = data.at ?? "—";

    document.getElementById("wPath").setAttribute("d", pointsToPath(data.series));
  }

  // ===== render market list =====
  async function renderMarketList(){
    const mode = document.querySelector("[data-toggle] button.active")?.dataset.mode || "intraday";
    const items = await api(`/api/widgets/market?symbols=${encodeURIComponent(MARKET.join(","))}&mode=${mode}`);

    const list = document.getElementById("wList");
    list.innerHTML = items.map(it=>{
      const up = (it.change ?? 0) >= 0;
      return `
        <article class="w-item">
          <div class="w-item-left">
            <div class="w-dot ${up?"up":"down"}"></div>
            <div>
              <div class="w-sym">${it.symbol}</div>
              <div class="w-price">${fmt(it.price)} <span class="w-usd">${it.currency || "USD"}</span></div>
              <div class="w-change ${up?"up":"down"}">${up?"+":""}${fmt(it.change)} (${up?"+":""}${fmtPct(it.changePct)})</div>
              <div class="w-time">${it.time || ""}</div>
            </div>
          </div>
          <div class="w-item-right">
            <div class="w-tag">${mode}</div>
            <div class="w-spark ${up?"up":"down"}"></div>
          </div>
        </article>
      `;
    }).join("");
  }

  // ===== render crypto ticker =====
  async function renderCryptoTicker(){
    const items = await api(`/api/widgets/crypto?symbols=${encodeURIComponent(CRYPTO.join(","))}`);

    const line = items.map(it=>{
      const name = (it.symbol || "").replace("-USD","");
      const pct = it.changePct ?? 0;
      const down = pct < 0;
      return `<span class="w-tk"><b>${name}</b> <i class="${down?"down":"up"}">${down?"▼":"▲"} ${fmtPct(Math.abs(pct))}</i></span>`;
    }).join("");

    document.getElementById("wRun").innerHTML =
      `<div class="w-row">${line}</div><div class="w-row">${line}</div>`;
  }

  // ===== auto cycle tech giants (optional) =====
  function startAuto(){
    stopAuto();
    autoTimer = setInterval(async ()=>{
      autoIndex = (autoIndex + 1) % TECH.length;
      const next = TECH[autoIndex];

      // set active pill
      document.querySelectorAll("[data-tabs] .w-pill").forEach(b=>{
        b.classList.toggle("active", b.dataset.symbol === next);
      });

      activeSymbol = next;
      await renderBigCard();
    }, 8000);
  }
  function stopAuto(){
    if(autoTimer) clearInterval(autoTimer);
    autoTimer = null;
  }

  // ===== events =====
  document.querySelector("[data-tabs]").addEventListener("click", async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    stopAuto();
    document.querySelectorAll("[data-tabs] .w-pill").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    activeSymbol = btn.dataset.symbol;
    await renderBigCard();
    startAuto();
  });

  document.querySelector("[data-range]").addEventListener("click", async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    document.querySelectorAll("[data-range] .w-range-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    activeRange = RANGE_MAP[btn.dataset.r] || "1mo";
    await renderBigCard();
  });

  document.querySelector("[data-toggle]").addEventListener("click", async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    document.querySelectorAll("[data-toggle] button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    await renderMarketList();
  });

  document.getElementById("wRefresh").addEventListener("click", async ()=>{
    await renderMarketList();
    await renderCryptoTicker();
  });

  // ===== init =====
  (async function init(){
    autoIndex = 0;
    await renderBigCard();
    await renderMarketList();
    await renderCryptoTicker();
    startAuto();

    setInterval(renderCryptoTicker, 30000);
    setInterval(renderMarketList, 60000);
  })();
</script>
{% endblock %}
